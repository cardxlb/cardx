<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CARDX Builder</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#05060B;color:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 6px;font-size:28px}
    p{margin:0 0 18px;color:rgba(255,255,255,.7)}
    .card{background:rgba(14,16,28,.8);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:18px;box-shadow:0 24px 70px rgba(0,0,0,.55)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:12px;color:rgba(255,255,255,.75);margin:6px 0}
    input,textarea,select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:#fff;outline:none
    }
    textarea{min-height:86px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);color:#fff;cursor:pointer
    }
    button:hover{border-color:rgba(58,128,246,.85)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:rgba(255,255,255,.75)}
    .ok{color:#7CFF9A}
    .warn{color:#FFD37C}
    .err{color:#FF7C7C}
    .full{grid-column:1/-1}
    .previewBox{margin-top:14px;padding:12px;border-radius:14px;background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.18)}
    a{color:#7fb0ff}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:16px 0}
    .toggleRow{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .small{font-size:12px;color:rgba(255,255,255,.68)}
    .hidden{display:none}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06)
    }

    /* Integrated / half-field groups */
    .group{display:flex;gap:8px;align-items:stretch}
    .group input{border-radius:12px}
    .group .fixed{
      display:flex;align-items:center;justify-content:center;
      padding:0 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:rgba(255,255,255,.85);
      font-size:14px;white-space:nowrap
    }
    .group .cc{max-width:92px; text-align:center}
    .group .user{min-width:0; flex: 1}
    .group .domain{min-width:0; flex: 1}
    .help{margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CARDX Contact Card Builder</h1>
    <p>Generate + upload <span class="mono">firstname_lastname.html</span>, <span class="mono">.vcf</span>, <span class="mono">.jpg</span> to your GitHub repo.</p>

    <div class="card">
      <div class="grid">
        <div>
          <label>GitHub Owner</label>
          <input id="owner" value="cardxlb" />
        </div>
        <div>
          <label>GitHub Repo</label>
          <input id="repo" value="cardx" />
        </div>
        <div>
          <label>Branch</label>
          <input id="branch" value="main" />
        </div>
        <div>
          <label>Folder path in repo (blank = root)</label>
          <input id="path" placeholder="" />
        </div>

        <div class="full">
          <label>GitHub Token (Fine-grained PAT with Contents: Read/Write)</label>
          <input id="token" type="password" placeholder="Paste token here (stored only in your browser)" />
          <div class="mono help">Tip: saved in <b>localStorage</b> if you click “Save Token”.</div>
        </div>

        <div>
          <label>First name</label>
          <input id="first" value="Mahmoud" />
        </div>
        <div>
          <label>Last name</label>
          <input id="last" value="Chatila" />
        </div>

        <div class="full">
          <label>Full display name (FN) (optional — defaults to First + Last)</label>
          <input id="fn" value="Mahmoud Chatila" />
        </div>

        <div>
          <label>Company (ORG) (optional)</label>
          <input id="org" value="Chatila Financial Group" />
        </div>
        <div>
          <label>Title (TITLE) (optional)</label>
          <input id="title" value="Chief Executive Officer" />
        </div>

        <!-- Integrated PHONE -->
        <div class="full">
          <label>Phone (optional)</label>
          <div class="group">
            <span class="fixed">+</span>
            <input id="phone_cc" class="cc" inputmode="numeric" placeholder="cc" value="961" />
            <input id="phone_num" class="user" inputmode="numeric" placeholder="number" value="78929249" />
          </div>
          <div class="small help">Produces: <span class="mono">+ccnumber</span> (E.164)</div>
        </div>

        <!-- Integrated WHATSAPP -->
        <div class="full">
          <label>WhatsApp (optional)</label>
          <div class="group">
            <span class="fixed">wa.me/</span>
            <input id="wa_cc" class="cc" inputmode="numeric" placeholder="cc" value="961" />
            <input id="wa_num" class="user" inputmode="numeric" placeholder="number" value="78929249" />
          </div>
          <div class="small help">Produces: <span class="mono">https://wa.me/ccnumber</span></div>
        </div>

        <!-- Integrated EMAIL -->
        <div class="full">
          <label>Email (optional)</label>
          <div class="group">
            <input id="email_user" class="user" placeholder="username" value="mahmoudchatila974" />
            <span class="fixed">@</span>
            <input id="email_domain" class="domain" placeholder="domain.com" value="gmail.com" />
          </div>
          <div class="small help">Produces: <span class="mono">username@domain.com</span></div>
        </div>

        <!-- Instagram username only -->
        <div class="full">
          <label>Instagram (optional)</label>
          <div class="group">
            <span class="fixed">instagram.com/</span>
            <input id="ig_user" class="user" placeholder="username" value="mahmoud__chatila" />
          </div>
          <div class="small help">Produces: <span class="mono">https://instagram.com/username</span></div>
        </div>

        <div class="full">
          <label>Location URL (Google Maps link) (optional)</label>
          <input id="maps" value="https://maps.app.goo.gl/QyvitV4g9yrkvxcp7" />
        </div>

        <div class="full">
          <label>Notes (optional)</label>
          <textarea id="note" placeholder="Optional note in the contact card"></textarea>
        </div>

        <div class="full">
          <label>Profile image (.jpg/.png) (optional — if empty, NO image section appears)</label>
          <input id="photo" type="file" accept="image/*" />
          <div class="mono help" id="photoInfo">No image selected.</div>
        </div>

        <div class="full divider"></div>

        <!-- Advanced toggle -->
        <div class="full toggleRow">
          <div>
            <div class="pill">
              <input id="showAdvanced" type="checkbox" />
              <label for="showAdvanced" style="margin:0;cursor:pointer;">Show advanced fields</label>
            </div>
            <div class="small">Default stays simple. Advanced adds extra vCard + extra buttons. Empty advanced fields won’t show.</div>
          </div>
          <div class="small mono" id="existsLine">—</div>
        </div>

        <!-- ADVANCED FIELDS (hidden by default) -->
        <div id="advancedSection" class="full hidden">
          <div class="grid" style="margin-top:12px">
            <div class="full">
              <label>Website URL (optional)</label>
              <input id="url" placeholder="https://example.com" />
            </div>

            <div class="full">
              <label>Telegram username (optional)</label>
              <div class="group">
                <span class="fixed">t.me/</span>
                <input id="tg_user" class="user" placeholder="username" />
              </div>
            </div>

            <div class="full">
              <label>Second phone (Work) (optional)</label>
              <div class="group">
                <span class="fixed">+</span>
                <input id="work_cc" class="cc" inputmode="numeric" placeholder="cc" />
                <input id="work_num" class="user" inputmode="numeric" placeholder="number" />
              </div>
            </div>

            <div class="full">
              <label>Address (ADR) (optional)</label>
              <input id="adr" placeholder="Street;City;Region;Postal;Country" />
              <div class="small help">Example: <span class="mono">Verdun;Beirut;;;Lebanon</span></div>
            </div>

            <div class="full">
              <label>Categories (comma separated) (optional)</label>
              <input id="categories" placeholder="Finance,Crypto,Business" />
            </div>
          </div>
        </div>
      </div>

      <div class="previewBox">
        <div class="mono">Slug / filenames:</div>
        <div class="mono" id="slugLine">—</div>
        <div class="mono" style="margin-top:8px;">Expected GitHub Pages URLs:</div>
        <div class="mono" id="urlsLine">—</div>
      </div>

      <div class="row">
        <button id="saveTokenBtn">Save Token</button>
        <button id="loadTokenBtn">Load Saved Token</button>
        <button id="clearTokenBtn">Clear Saved Token</button>
        <button id="downloadBtn">Download files</button>
        <button id="uploadBtn">Upload to GitHub</button>
      </div>

      <div class="mono" style="margin-top:12px;" id="status"></div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  function slugify(first, last){
    const clean = (s)=> (s||"")
      .trim().toLowerCase()
      .replace(/\s+/g, "_")
      .replace(/[^a-z0-9_]/g, "");
    const a = clean(first), b = clean(last);
    return [a,b].filter(Boolean).join("_") || "contact";
  }

  function digitsOnly(s){ return String(s||"").replace(/\D/g,""); }

  function base64FromText(text){
    return btoa(unescape(encodeURIComponent(text)));
  }

  function filePathJoin(path, filename){
    if(!path) return filename;
    return path.replace(/\/+$/,"") + "/" + filename;
  }

  function normalizeInstagram(user){
    const u = String(user||"").trim().replace(/^@/,"");
    return u ? `https://instagram.com/${u}` : "";
  }

  function buildEmail(user, domain){
    const u = String(user||"").trim();
    const d = String(domain||"").trim().replace(/^@/,"");
    if(!u || !d) return "";
    return `${u}@${d}`;
  }

  function buildE164(cc, num){
    const c = digitsOnly(cc);
    const n = digitsOnly(num);
    if(!c || !n) return "";
    return `+${c}${n}`;
  }

  function buildWaDigits(cc, num){
    const c = digitsOnly(cc);
    const n = digitsOnly(num);
    if(!c || !n) return "";
    return `${c}${n}`;
  }

  function buildAdrLine(adrRaw){
    const s = String(adrRaw||"").trim();
    if(!s) return "";
    const parts = s.split(";").map(x=>x.trim());
    const street = parts[0] || "";
    const city   = parts[1] || "";
    const region = parts[2] || "";
    const postal = parts[3] || "";
    const country= parts[4] || "";
    return `ADR;TYPE=WORK:;;${street};${city};${region};${postal};${country}`;
  }

  function buildVcf(data){
    const lines = [
      "BEGIN:VCARD",
      "VERSION:3.0",
      `N:${data.last};${data.first};;;`,
      `FN:${data.fn}`,
      data.org ? `ORG:${data.org}` : "",
      data.title ? `TITLE:${data.title}` : "",
      data.tel_e164 ? `TEL;TYPE=CELL:${data.tel_e164}` : "",
      data.email ? `EMAIL;TYPE=INTERNET:${data.email}` : "",
      data.note ? `NOTE:${data.note.replace(/\n/g,"\\n")}` : "",
    ];

    if(data.advanced){
      if(data.url) lines.push(`URL:${data.url}`);
      if(data.tg_user) lines.push(`X-SOCIALPROFILE;TYPE=telegram:https://t.me/${data.tg_user}`);
      if(data.work_e164) lines.push(`TEL;TYPE=WORK:${data.work_e164}`);
      const adrLine = buildAdrLine(data.adr_raw);
      if(adrLine) lines.push(adrLine);
      if(data.categories) lines.push(`CATEGORIES:${data.categories}`);
    }

    lines.push("END:VCARD");
    return lines.filter(Boolean).join("\n");
  }

  function buildHtml(data){
    const owner = data.owner, repo = data.repo, branch = data.branch, path = data.path;
    const slug = data.slug;

    const basePages = `https://${owner}.github.io/${repo}`;
    const prefix = path ? path.replace(/^\/+|\/+$/g,"") + "/" : "";
    const vcfUrl = `${basePages}/${prefix}${slug}.vcf`;

    const hasPhoto = !!data.has_photo;
    const imgRaw = hasPhoto
      ? `https://raw.githubusercontent.com/${owner}/${repo}/refs/heads/${branch}/${prefix}${slug}.jpg`
      : "";

    const igUrl = data.ig_url || "";
    const waLink = data.wa_digits ? `https://wa.me/${data.wa_digits}` : "";
    const telLink = data.tel_e164 ? `tel:${data.tel_e164}` : "";
    const mailLink = data.email ? `mailto:${data.email}` : "";

    const showSubtitle = !!(data.title || data.org);

    const extraButtons = data.advanced ? `
        ${data.url ? `
        <a class="btn" href="${escapeAttr(data.url)}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/globe2.svg" alt="">
          <span>Website</span><span></span>
        </a>` : ""}

        ${data.tg_user ? `
        <a class="btn" href="https://t.me/${escapeAttr(data.tg_user)}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/send.svg" alt="">
          <span>Telegram</span><span></span>
        </a>` : ""}
    ` : "";

    return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>${escapeHtml(data.fn)} – CARDX</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; background: #05060B; }
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: rgba(255,255,255,0.92);
  }
  .bg{
    position: fixed;
    inset: 0;
    z-index: -1;
    background:
      radial-gradient(900px 520px at 18% 10%, rgba(58,128,246,0.28), transparent 60%),
      radial-gradient(900px 520px at 82% 18%, rgba(58,128,246,0.14), transparent 60%),
      linear-gradient(180deg, #05060B, #070914);
  }
  .page{
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: clamp(16px, 3vw, 36px);
  }
  .stack{
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: calc(var(--u) * 1.2);
  }
  :root{ --u: clamp(11px, 1.15vw + 7px, 18px); }
  .container{
    width: min(92vw, calc(var(--u) * 42));
    padding: calc(var(--u) * 2.1) calc(var(--u) * 1.5);
    border-radius: calc(var(--u) * 2.1);
    background: rgba(14,16,28,0.80);
    border: 1px solid rgba(255,255,255,0.10);
    box-shadow: 0 calc(var(--u) * 2.2) calc(var(--u) * 6.2) rgba(0,0,0,0.75);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .container::before{
    content:"";
    position:absolute;
    inset: 0;
    border-radius: inherit;
    background: radial-gradient(
      calc(var(--u) * 46) calc(var(--u) * 22) at 50% 0%,
      rgba(255,255,255,0.10),
      transparent 60%
    );
    pointer-events:none;
  }
  img.profile{
    width: calc(var(--u) * 15.8);
    height: calc(var(--u) * 15.8);
    border-radius: calc(var(--u) * 2.0);
    object-fit: cover;
    display: block;
    margin: calc(var(--u) * 0.6) auto calc(var(--u) * 1.4);
    box-shadow: 0 calc(var(--u) * 1.3) calc(var(--u) * 4.2) rgba(0,0,0,0.65);
    outline: 2px solid rgba(58,128,246,0.75);
    outline-offset: calc(var(--u) * 0.6);
  }
  h1{
    margin: calc(var(--u) * 0.5) 0 calc(var(--u) * 0.5);
    font-size: calc(var(--u) * 2.55);
    font-weight: 820;
    letter-spacing: -0.02em;
  }
  h2{
    margin: 0 0 calc(var(--u) * 1.6);
    font-size: calc(var(--u) * 1.25);
    font-weight: 450;
    color: rgba(255,255,255,0.62);
  }
  a.btn{
    width: 92%;
    max-width: calc(var(--u) * 34.5);
    margin: calc(var(--u) * 0.85) auto;
    padding: calc(var(--u) * 1.15) calc(var(--u) * 1.7);
    display: grid;
    grid-template-columns: calc(var(--u) * 2.2) 1fr calc(var(--u) * 2.2);
    align-items: center;
    text-decoration: none;
    color: rgba(255,255,255,0.94);
    background:
      linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)),
      rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 999px;
    box-shadow: 0 calc(var(--u) * 1.05) calc(var(--u) * 2.9) rgba(0,0,0,0.55);
    transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
  }
  a.btn:hover{
    transform: translateY(-2px);
    border-color: rgba(58,128,246,0.85);
    box-shadow:
      0 calc(var(--u) * 1.6) calc(var(--u) * 4.1) rgba(0,0,0,0.70),
      0 0 0 1px rgba(58,128,246,0.22);
  }
  .icon{
    justify-self: start;
    width: calc(var(--u) * 1.9);
    height: calc(var(--u) * 1.9);
    filter: brightness(0) invert(1);
    opacity: 0.95;
  }
  .btn span{
    justify-self: center;
    text-align: center;
    font-size: calc(var(--u) * 1.45);
    font-weight: 600;
  }
  .footer{
    font-size: calc(var(--u) * 0.95);
    color: rgba(255,255,255,0.60);
    text-align: center;
    margin-bottom: calc(var(--u) * 0.4);
  }
  .footer strong{
    color: #3A80F6;
    font-weight: 800;
  }
</style>
</head>
<body>
  <div class="bg"></div>
  <main class="page">
    <div class="stack">
      <div class="container">
        ${hasPhoto ? `<img src="${imgRaw}" class="profile" alt="Profile Photo" />` : ""}

        <h1>${escapeHtml(data.fn)}</h1>
        ${showSubtitle ? `<h2>${escapeHtml(data.title || "")}${(data.title && data.org) ? " – " : ""}${escapeHtml(data.org || "")}</h2>` : ""}

        <a class="btn" href="${vcfUrl}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/person-check.svg" alt="">
          <span>Save Contact</span><span></span>
        </a>

        ${telLink ? `
        <a class="btn" href="${escapeAttr(telLink)}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/telephone.svg" alt="">
          <span>Call</span><span></span>
        </a>` : ""}

        ${waLink ? `
        <a class="btn" href="${escapeAttr(waLink)}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/whatsapp.svg" alt="">
          <span>WhatsApp</span><span></span>
        </a>` : ""}

        ${mailLink ? `
        <a class="btn" href="${escapeAttr(mailLink)}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/envelope.svg" alt="">
          <span>Email</span><span></span>
        </a>` : ""}

        ${igUrl ? `
        <a class="btn" href="${escapeAttr(igUrl)}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/instagram.svg" alt="">
          <span>Instagram</span><span></span>
        </a>` : ""}

        ${data.maps ? `
        <a class="btn" href="${escapeAttr(data.maps)}">
          <img class="icon" src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/geo-alt.svg" alt="">
          <span>Location</span><span></span>
        </a>` : ""}

        ${extraButtons}
      </div>

      <div class="footer">
        Powered by <strong>CARDX</strong> • A smarter way to connect
      </div>
    </div>
  </main>
</body>
</html>`;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  function collect(){
    const owner = $("owner").value.trim();
    const repo = $("repo").value.trim();
    const branch = $("branch").value.trim() || "main";
    const path = $("path").value.trim().replace(/^\/+|\/+$/g,"");

    const first = $("first").value.trim();
    const last  = $("last").value.trim();
    const slug  = slugify(first,last);

    const fallbackFN = [first,last].filter(Boolean).join(" ").trim();
    const fn = $("fn").value.trim() || fallbackFN || slug;

    const tel_e164  = buildE164($("phone_cc").value, $("phone_num").value);
    const wa_digits = buildWaDigits($("wa_cc").value, $("wa_num").value);

    const email = buildEmail($("email_user").value, $("email_domain").value);
    const ig_url = normalizeInstagram($("ig_user").value);

    const advanced = $("showAdvanced").checked;

    const work_e164 = advanced ? buildE164($("work_cc").value, $("work_num").value) : "";
    const url = advanced ? $("url").value.trim() : "";
    const tg_user = advanced ? $("tg_user").value.trim().replace(/^@/,"") : "";
    const adr_raw = advanced ? $("adr").value.trim() : "";
    const categories = advanced ? $("categories").value.trim().replace(/\s*,\s*/g, ",") : "";

    const has_photo = !!($("photo").files?.[0]);

    return {
      owner, repo, branch, path,
      first, last, slug,
      fn,
      org: $("org").value.trim(),
      title: $("title").value.trim(),
      tel_e164,
      wa_digits,
      email,
      ig_url,
      maps: $("maps").value.trim(),
      note: $("note").value.trim(),
      has_photo,
      advanced,
      // advanced extras
      work_e164, url, tg_user, adr_raw, categories
    };
  }

  function updatePreview(){
    const d = collect();
    $("slugLine").textContent = `${d.slug}.html | ${d.slug}.vcf` + (d.has_photo ? ` | ${d.slug}.jpg` : ``);

    const basePages = `https://${d.owner}.github.io/${d.repo}`;
    const prefix = d.path ? `/${d.path}` : "";
    $("urlsLine").innerHTML =
      `<a href="${basePages}${prefix}/${d.slug}.html" target="_blank">${basePages}${prefix}/${d.slug}.html</a><br>` +
      `<a href="${basePages}${prefix}/${d.slug}.vcf" target="_blank">${basePages}${prefix}/${d.slug}.vcf</a>`;
  }

  async function readImageBase64(file){
    const dataUrl = await new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(r.result);
      r.onerror = ()=>reject(new Error("Failed to read image"));
      r.readAsDataURL(file);
    });
    const [, b64] = String(dataUrl).split(",");
    return { base64: b64 };
  }

  async function checkIfExists({owner, repo, token, path, filename}){
    const fullPath = filePathJoin(path, filename);
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(fullPath).replace(/%2F/g,"/")}`;
    const res = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" }
    });
    return res.ok;
  }

  async function putFile({owner, repo, branch, token, path, filename, contentBase64, message}){
    const fullPath = filePathJoin(path, filename);
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(fullPath).replace(/%2F/g,"/")}`;

    let sha = null;
    const getRes = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" }
    });
    if(getRes.ok){
      const j = await getRes.json();
      sha = j.sha;
    }

    const body = { message, content: contentBase64, branch };
    if(sha) body.sha = sha;

    const putRes = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Accept": "application/vnd.github+json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if(!putRes.ok){
      const t = await putRes.text();
      throw new Error(`Upload failed for ${filename}: ${putRes.status} ${t}`);
    }
    return await putRes.json();
  }

  function setStatus(msg, cls="mono"){
    const el = $("status");
    el.className = "mono " + (cls || "");
    el.textContent = msg;
  }

  async function updateExistsBadge(){
    try{
      const token = $("token").value.trim();
      const d = collect();
      if(!token){
        $("existsLine").textContent = "Name status: (token required)";
        $("existsLine").className = "small mono warn";
        return;
      }
      const exists = await checkIfExists({
        owner: d.owner, repo: d.repo, token,
        path: d.path,
        filename: `${d.slug}.html`
      });
      $("existsLine").textContent = exists ? "Name status: EXISTS" : "Name status: AVAILABLE";
      $("existsLine").className = "small mono " + (exists ? "warn" : "ok");
    }catch{
      $("existsLine").textContent = "Name status: (check failed)";
      $("existsLine").className = "small mono warn";
    }
  }

  // events
  const watchIds = [
    "owner","repo","branch","path","token",
    "first","last","fn","org","title",
    "phone_cc","phone_num","wa_cc","wa_num",
    "email_user","email_domain","ig_user","maps","note",
    "showAdvanced","url","tg_user","work_cc","work_num","adr","categories"
  ];
  watchIds.forEach(id=>{
    $(id).addEventListener("input", ()=>{
      updatePreview();
      window.clearTimeout(window.__exDebounce);
      window.__exDebounce = window.setTimeout(updateExistsBadge, 350);
    });
    $(id).addEventListener("change", ()=>{
      updatePreview();
      window.clearTimeout(window.__exDebounce);
      window.__exDebounce = window.setTimeout(updateExistsBadge, 350);
    });
  });

  $("showAdvanced").addEventListener("change", ()=>{
    $("advancedSection").classList.toggle("hidden", !$("showAdvanced").checked);
    updatePreview();
  });

  $("photo").addEventListener("change", ()=>{
    const f = $("photo").files?.[0];
    $("photoInfo").textContent = f ? `Selected: ${f.name} (${Math.round(f.size/1024)} KB)` : "No image selected.";
    updatePreview();
  });

  $("saveTokenBtn").addEventListener("click", ()=>{
    const tok = $("token").value.trim();
    if(!tok) return setStatus("No token to save.", "warn");
    localStorage.setItem("cardx_github_token", tok);
    setStatus("Token saved in localStorage.", "ok");
    updateExistsBadge();
  });
  $("loadTokenBtn").addEventListener("click", ()=>{
    const tok = localStorage.getItem("cardx_github_token") || "";
    $("token").value = tok;
    setStatus(tok ? "Loaded saved token." : "No saved token found.", tok ? "ok" : "warn");
    updateExistsBadge();
  });
  $("clearTokenBtn").addEventListener("click", ()=>{
    localStorage.removeItem("cardx_github_token");
    $("token").value = "";
    setStatus("Saved token cleared.", "ok");
    updateExistsBadge();
  });

  $("downloadBtn").addEventListener("click", async ()=>{
    try{
      const d = collect();
      const vcf = buildVcf(d);
      const html = buildHtml(d);

      downloadText(`${d.slug}.vcf`, vcf);
      downloadText(`${d.slug}.html`, html);

      const f = $("photo").files?.[0];
      if(f) downloadBlob(`${d.slug}.jpg`, f);

      setStatus(`Downloaded ${d.slug}.html + ${d.slug}.vcf` + (f ? ` + ${d.slug}.jpg` : ``), "ok");
    }catch(e){
      setStatus(e.message, "err");
    }
  });

  $("uploadBtn").addEventListener("click", async ()=>{
    try{
      const token = $("token").value.trim();
      if(!token) throw new Error("Paste your GitHub token first.");

      const d = collect();
      const slug = d.slug;

      setStatus("Checking if name already exists…");
      const exists = await checkIfExists({
        owner: d.owner, repo: d.repo, token,
        path: d.path,
        filename: `${slug}.html`
      });

      if(exists){
        const ok = confirm(
          `⚠️ The name "${slug}" is already used.\n\n` +
          `Files like ${slug}.html already exist.\n\n` +
          `Overwrite?`
        );
        if(!ok){
          setStatus("Upload cancelled. Choose a different name.", "warn");
          return;
        }
      }

      const vcf = buildVcf(d);
      const html = buildHtml(d);

      setStatus("Uploading .vcf…");
      await putFile({
        owner: d.owner, repo: d.repo, branch: d.branch, token,
        path: d.path,
        filename: `${slug}.vcf`,
        contentBase64: base64FromText(vcf),
        message: `CARDX: update ${slug}.vcf`
      });

      setStatus("Uploading .html…");
      await putFile({
        owner: d.owner, repo: d.repo, branch: d.branch, token,
        path: d.path,
        filename: `${slug}.html`,
        contentBase64: base64FromText(html),
        message: `CARDX: update ${slug}.html`
      });

      const imgFile = $("photo").files?.[0];
      if(imgFile){
        setStatus("Uploading image…");
        const img = await readImageBase64(imgFile);
        await putFile({
          owner: d.owner, repo: d.repo, branch: d.branch, token,
          path: d.path,
          filename: `${slug}.jpg`,
          contentBase64: img.base64,
          message: `CARDX: update ${slug}.jpg`
        });
      }

      const basePages = `https://${d.owner}.github.io/${d.repo}`;
      const prefix = d.path ? `/${d.path}` : "";
      setStatus(`Done. Open: ${basePages}${prefix}/${slug}.html`, "ok");
      updatePreview();
      updateExistsBadge();
    }catch(e){
      setStatus(e.message, "err");
    }
  });

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    downloadBlob(filename, blob);
  }
  function downloadBlob(filename, blobOrFile){
    const url = URL.createObjectURL(blobOrFile);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // init
  updatePreview();
  $("advancedSection").classList.toggle("hidden", !$("showAdvanced").checked);
  const saved = localStorage.getItem("cardx_github_token");
  if(saved) $("token").value = saved;
  updateExistsBadge();
</script>
</body>
</html>
